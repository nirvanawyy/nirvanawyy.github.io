<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    

    <title>
      玩转node.js(2) | re.zero to hero 
    </title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
      <meta name="author" content="John Doe">
    
    

    <meta name="description" content="基于状态机模型的斗地主游戏（NodeJs&amp;amp;SocketIO）NodeJs 实现斗地主游戏1. 系统结构系统考虑使用Nodejs和SocketIo实现服务器端逻辑，前端使用HTML5。 2. 逻辑流程1 . 主要逻辑包括用户进入游戏、等待对家进入游戏、游戏过程、结束统计这4个过程。 2 . 游戏过程的逻辑具体如下 3 . 服务器-客户端通讯逻辑如下 3. 客户端界面设计1 . 登录界面 2">
<meta property="og:type" content="article">
<meta property="og:title" content="玩转node.js(2) | re.zero to hero">
<meta property="og:url" content="http://yoursite.com/2017/05/01/nodejs2/index.html">
<meta property="og:site_name" content="re.zero to hero">
<meta property="og:description" content="基于状态机模型的斗地主游戏（NodeJs&amp;amp;SocketIO）NodeJs 实现斗地主游戏1. 系统结构系统考虑使用Nodejs和SocketIo实现服务器端逻辑，前端使用HTML5。 2. 逻辑流程1 . 主要逻辑包括用户进入游戏、等待对家进入游戏、游戏过程、结束统计这4个过程。 2 . 游戏过程的逻辑具体如下 3 . 服务器-客户端通讯逻辑如下 3. 客户端界面设计1 . 登录界面 2">
<meta property="og:image" content="http://yoursite.com/2017/05/01/nodejs2/1.png">
<meta property="og:image" content="http://yoursite.com/2017/05/01/nodejs2/2.png">
<meta property="og:image" content="http://yoursite.com/2017/05/01/nodejs2/3.png">
<meta property="og:image" content="http://yoursite.com/2017/05/01/nodejs2/4.png">
<meta property="og:image" content="http://yoursite.com/2017/05/01/nodejs2/5.png">
<meta property="og:image" content="http://yoursite.com/2017/05/01/nodejs2/6.gif">
<meta property="og:image" content="http://yoursite.com/2017/05/01/nodejs2/6.png">
<meta property="og:image" content="http://yoursite.com/2017/05/01/nodejs2/8.png">
<meta property="og:updated_time" content="2017-05-01T14:25:41.687Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="玩转node.js(2) | re.zero to hero">
<meta name="twitter:description" content="基于状态机模型的斗地主游戏（NodeJs&amp;amp;SocketIO）NodeJs 实现斗地主游戏1. 系统结构系统考虑使用Nodejs和SocketIo实现服务器端逻辑，前端使用HTML5。 2. 逻辑流程1 . 主要逻辑包括用户进入游戏、等待对家进入游戏、游戏过程、结束统计这4个过程。 2 . 游戏过程的逻辑具体如下 3 . 服务器-客户端通讯逻辑如下 3. 客户端界面设计1 . 登录界面 2">
<meta name="twitter:image" content="http://yoursite.com/2017/05/01/nodejs2/1.png">
    
    
    
      <link rel="icon" type="image/x-icon" href="/favicon.png">
    
    <link rel="stylesheet" href="/css/uno.css">
    <link rel="stylesheet" href="/css/highlight.css">
    <link rel="stylesheet" href="/css/archive.css">
    <link rel="stylesheet" href="/css/china-social-icon.css">

</head>
<body>

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    

<header class="panel-cover panel-cover--collapsed">


  <div class="panel-main">

  
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        

        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage">re.zero to hero</a></h1>
        <hr class="panel-cover__divider" />

        

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">

              
                
                <li class="navigation__item"><a href="/#blog" title="" class="blog-button">首页</a></li>
              
                
                <li class="navigation__item"><a href="/about" title="" class="">关于</a></li>
              
                
                <li class="navigation__item"><a href="/archive" title="" class="">归档</a></li>
              
                
                <li class="navigation__item"><a href="/photo" title="" class="">照片</a></li>
              

            </ul>
          </nav>

          <!-- ----------------------------
To add a new social icon simply duplicate one of the list items from below
and change the class in the <i> tag to match the desired social network
and then add your link to the <a>. Here is a full list of social network
classes that you can use:

    icon-social-500px
    icon-social-behance
    icon-social-delicious
    icon-social-designer-news
    icon-social-deviant-art
    icon-social-digg
    icon-social-dribbble
    icon-social-facebook
    icon-social-flickr
    icon-social-forrst
    icon-social-foursquare
    icon-social-github
    icon-social-google-plus
    icon-social-hi5
    icon-social-instagram
    icon-social-lastfm
    icon-social-linkedin
    icon-social-medium
    icon-social-myspace
    icon-social-path
    icon-social-pinterest
    icon-social-rdio
    icon-social-reddit
    icon-social-skype
    icon-social-spotify
    icon-social-stack-overflow
    icon-social-steam
    icon-social-stumbleupon
    icon-social-treehouse
    icon-social-tumblr
    icon-social-twitter
    icon-social-vimeo
    icon-social-xbox
    icon-social-yelp
    icon-social-youtube
    icon-social-zerply
    icon-mail

-------------------------------->

<!-- add social info here -->




        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner entry">
            

<article class="post-container post-container--single">

  <header class="post-header">
    
    <h1 class="post-title">玩转node.js(2)</h1>

    

    <div class="post-meta">
      <time datetime="2017-05-01" class="post-meta__date date">2017-05-01</time> 

      <span class="post-meta__tags tags">

          

          

      </span>
    </div>
    
    

  </header>

  <section id="post-content" class="article-content post">
    <h2 id="基于状态机模型的斗地主游戏（NodeJs-amp-SocketIO）"><a href="#基于状态机模型的斗地主游戏（NodeJs-amp-SocketIO）" class="headerlink" title="基于状态机模型的斗地主游戏（NodeJs&amp;SocketIO）"></a>基于状态机模型的斗地主游戏（NodeJs&amp;SocketIO）</h2><h3 id="NodeJs-实现斗地主游戏"><a href="#NodeJs-实现斗地主游戏" class="headerlink" title="NodeJs 实现斗地主游戏"></a>NodeJs 实现斗地主游戏</h3><h4 id="1-系统结构"><a href="#1-系统结构" class="headerlink" title="1. 系统结构"></a>1. 系统结构</h4><h5 id="系统考虑使用Nodejs和SocketIo实现服务器端逻辑，前端使用HTML5。"><a href="#系统考虑使用Nodejs和SocketIo实现服务器端逻辑，前端使用HTML5。" class="headerlink" title="系统考虑使用Nodejs和SocketIo实现服务器端逻辑，前端使用HTML5。"></a>系统考虑使用Nodejs和SocketIo实现服务器端逻辑，前端使用HTML5。</h5><p><img src="/2017/05/01/nodejs2/1.png" alt="Alert~"></p>
<h4 id="2-逻辑流程"><a href="#2-逻辑流程" class="headerlink" title="2. 逻辑流程"></a>2. 逻辑流程</h4><h5 id="1-主要逻辑包括用户进入游戏、等待对家进入游戏、游戏过程、结束统计这4个过程。"><a href="#1-主要逻辑包括用户进入游戏、等待对家进入游戏、游戏过程、结束统计这4个过程。" class="headerlink" title="1 . 主要逻辑包括用户进入游戏、等待对家进入游戏、游戏过程、结束统计这4个过程。"></a>1 . 主要逻辑包括用户进入游戏、等待对家进入游戏、游戏过程、结束统计这4个过程。</h5><p><img src="/2017/05/01/nodejs2/2.png" alt="Alert~"></p>
<h5 id="2-游戏过程的逻辑具体如下"><a href="#2-游戏过程的逻辑具体如下" class="headerlink" title="2 . 游戏过程的逻辑具体如下"></a>2 . 游戏过程的逻辑具体如下</h5><p><img src="/2017/05/01/nodejs2/3.png" alt="Alert~"></p>
<h5 id="3-服务器-客户端通讯逻辑如下"><a href="#3-服务器-客户端通讯逻辑如下" class="headerlink" title="3 . 服务器-客户端通讯逻辑如下"></a>3 . 服务器-客户端通讯逻辑如下</h5><p><img src="/2017/05/01/nodejs2/4.png" alt="Alert~"></p>
<h4 id="3-客户端界面设计"><a href="#3-客户端界面设计" class="headerlink" title="3. 客户端界面设计"></a>3. 客户端界面设计</h4><h5 id="1-登录界面"><a href="#1-登录界面" class="headerlink" title="1 . 登录界面"></a>1 . 登录界面</h5><p><img src="/2017/05/01/nodejs2/5.png" alt="Alert~"></p>
<h5 id="2-发牌界面"><a href="#2-发牌界面" class="headerlink" title="2 . 发牌界面"></a>2 . 发牌界面</h5><p><img src="/2017/05/01/nodejs2/6.gif" alt="Alert~"></p>
<h4 id="4-数据结构"><a href="#4-数据结构" class="headerlink" title="4. 数据结构"></a>4. 数据结构</h4><h5 id="4-1-牌型"><a href="#4-1-牌型" class="headerlink" title="4.1 牌型"></a>4.1 牌型</h5><h6 id="为了便于计算，使用一维数组定义每张扑克的index，根据图中顺序，按从左到右以及从上到下递增（即左上角的红桃A为0-右上角的红桃K为12-方块A为13-以此类推）"><a href="#为了便于计算，使用一维数组定义每张扑克的index，根据图中顺序，按从左到右以及从上到下递增（即左上角的红桃A为0-右上角的红桃K为12-方块A为13-以此类推）" class="headerlink" title="为了便于计算，使用一维数组定义每张扑克的index，根据图中顺序，按从左到右以及从上到下递增（即左上角的红桃A为0,右上角的红桃K为12,方块A为13,以此类推）"></a>为了便于计算，使用一维数组定义每张扑克的index，根据图中顺序，按从左到右以及从上到下递增（即左上角的红桃A为0,右上角的红桃K为12,方块A为13,以此类推）</h6><p><img src="/2017/05/01/nodejs2/6.png" alt="Alert~"></p>
<h6 id="4-2-出牌规则"><a href="#4-2-出牌规则" class="headerlink" title="4.2 出牌规则"></a>4.2 出牌规则</h6><p>a 牌的大小顺序：大王，小王，2，A，K，Q，J，10，9，8，7，6，5，4，3。<br>b 牌形分为：单张、 一对、 三张、姐妹对（两张三张都可以连接，且连接数量无限）、顺子（数量无限制）、炸弹（不能4带1）：<br>c 除了炸弹以外，普通牌形不允许对压，相同牌形只有比它大的才能出。<br>d 炸弹任何牌形都能出，炸弹的大小为：天王炸，2，A，K，Q，J，10，9，8，7，6，5，4，3。</p>
<h6 id="4-3-比较大小"><a href="#4-3-比较大小" class="headerlink" title="4.3 比较大小"></a>4.3 比较大小</h6><p>根据牌型用整数定义扑克的数值大小<br>a 从3到K对应的value为2到12<br>b A对应13<br>c 2对应14<br>d 大小王对应16与15</p>
<h4 id="5-系统模块设计"><a href="#5-系统模块设计" class="headerlink" title="5. 系统模块设计"></a>5. 系统模块设计</h4><h5 id="5-1-出牌对象"><a href="#5-1-出牌对象" class="headerlink" title="5.1 出牌对象"></a>5.1 出牌对象</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> MODAL;</div><div class="line">$(init);</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">new</span> modal();</div><div class="line">    <span class="comment">//绑定页面上的出牌按钮,根据当前不同的状态运行不同的函数</span></div><div class="line">    $(<span class="string">"body"</span>).on(<span class="string">"click"</span>,<span class="string">"#sendCards"</span>,statusMachine);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">statusMachine</span>(<span class="params"></span>) </span>&#123;&#125;</div><div class="line"><span class="keyword">var</span> modal = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> ptrThis;</div><div class="line">    <span class="keyword">var</span> modalBox = &#123;</div><div class="line">        <span class="comment">//出牌对象的数据</span></div><div class="line">        <span class="keyword">default</span>:&#123;</div><div class="line">            <span class="comment">//cards存储服务器发送过来的扑克数组</span></div><div class="line">            cards:[<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">12</span>,<span class="number">13</span>,<span class="number">14</span>,<span class="number">15</span>,<span class="number">16</span>,<span class="number">17</span>,<span class="number">18</span>,<span class="number">19</span>,<span class="number">20</span>,<span class="number">21</span>,<span class="number">22</span>,<span class="number">23</span>,<span class="number">24</span>,<span class="number">25</span>,<span class="number">26</span>,<span class="number">27</span>,<span class="number">28</span>,<span class="number">29</span>,<span class="number">30</span>,<span class="number">31</span>,<span class="number">32</span>,<span class="number">33</span>,<span class="number">34</span>,<span class="number">35</span>,<span class="number">36</span>,<span class="number">37</span>,</div><div class="line">            <span class="number">38</span>,<span class="number">39</span>,<span class="number">40</span>,<span class="number">41</span>,<span class="number">42</span>,<span class="number">43</span>,<span class="number">44</span>,<span class="number">45</span>,<span class="number">46</span>,<span class="number">47</span>,<span class="number">48</span>,<span class="number">49</span>,<span class="number">50</span>,<span class="number">51</span>,<span class="number">52</span>,<span class="number">53</span>],</div><div class="line">            <span class="comment">//当前游戏的状态,有DISCARD(发牌),WATING(等待),GAMEOVER(游戏结束)三个状态</span></div><div class="line">            status:<span class="string">""</span>,</div><div class="line">            <span class="comment">//myIndex为玩家所处于的座位的座位号</span></div><div class="line">            myIndex:<span class="number">0</span>,</div><div class="line">            <span class="comment">//leftIndex为位于进行游戏的玩家左边的玩家的座位号</span></div><div class="line">            leftIndex:<span class="number">0</span>,</div><div class="line">            <span class="attr">rightIndex</span>:<span class="number">0</span>,</div><div class="line">            <span class="comment">//turn与座位号对应,turn表示由对应的座位号玩家进行操作(例如发牌,放弃)</span></div><div class="line">            turn:<span class="number">0</span>,</div><div class="line">            <span class="comment">//若有两位玩家放弃出牌,则第三位玩家必须出牌,用于标志新的出牌回合的开始</span></div><div class="line">            disCardTrue:<span class="literal">false</span>,</div><div class="line">            <span class="comment">//记录前一位玩家所处的牌,用于实现压牌逻辑</span></div><div class="line">            formercardsType:&#123;&#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="comment">//$goal为待插入扑克的jquery对象,cardArray为扑克数组,isDelay为true则延迟插入(隔0.3s插入一张牌)</span></div><div class="line">        placeCards:<span class="function"><span class="keyword">function</span> (<span class="params">$goal,cardArray,isDelay</span>) </span>&#123;&#125;,</div><div class="line">        <span class="comment">//sort函数所用到的比较函数,a,b都为扑克的index,将扑克按照value从大到小降序排列,value相同则按照花色排序</span></div><div class="line">        comp:<span class="function"><span class="keyword">function</span> (<span class="params">a,b</span>) </span>&#123;&#125;,</div><div class="line">        <span class="comment">//变换当前扑克牌的状态,未选取-&gt;选取,选取-&gt;未选取</span></div><div class="line">        toggleCard:<span class="function"><span class="keyword">function</span> (<span class="params">$this</span>) </span>&#123;&#125;,</div><div class="line">        <span class="comment">//将服务器发送的无序数组按照一定规则进行排序</span></div><div class="line">        cardsSort:<span class="function"><span class="keyword">function</span> (<span class="params">cards</span>) </span>&#123;&#125;,</div><div class="line">        <span class="comment">//将已被选中并发送的扑克牌从手牌中删除</span></div><div class="line">        removeCards:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;,</div><div class="line">        <span class="comment">//判断从服务器发送扑克牌数组是由谁发出的,调用placeCards函数插入扑克</span></div><div class="line">        <span class="comment">//turn设置为下一位玩家,根据turn设置status</span></div><div class="line">        <span class="comment">//如果扑克牌已被出完,则根据最后一位出牌人来判断当前玩家是胜利还是失败</span></div><div class="line">        justifyWhich:<span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;&#125;,</div><div class="line">        <span class="comment">//收到来自服务器转发的某一位玩家发送的投降信息</span></div><div class="line">        someOneTouXiang:<span class="function"><span class="keyword">function</span> (<span class="params">seats</span>) </span>&#123;&#125;,</div><div class="line">        <span class="comment">//清空玩家发送的扑克</span></div><div class="line">        clearCards:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;,</div><div class="line">        <span class="comment">//绘制左右两位玩家的界面,objLeft为左边的玩家的信息,objRight同上</span></div><div class="line">        drawothers:<span class="function"><span class="keyword">function</span> (<span class="params">objLeft,objRight</span>) </span>&#123;&#125;,</div><div class="line">        <span class="comment">//绘制玩家的界面,包含手牌,obj为相关信息</span></div><div class="line">        drawuser:<span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;&#125;,</div><div class="line">        <span class="comment">//向目标jquery对象插入图片,$this为目标jquery对象,obj为相关信息(例如图片路径)</span></div><div class="line">        insertImg:<span class="function"><span class="keyword">function</span> (<span class="params">$this,obj</span>) </span>&#123;&#125;,</div><div class="line">        <span class="comment">//移除目标jquery对象的图片,$this为目标jquery对象</span></div><div class="line">        removeImg:<span class="function"><span class="keyword">function</span> (<span class="params">$this</span>) </span>&#123;&#125;,</div><div class="line">        <span class="comment">//开始游戏,seats为服务器发送过来的座位对应着的用户的信息,turn指定座位下标为turn的用户先出牌(turn由服务器的随机数产生)</span></div><div class="line">        <span class="comment">//存储服务器发送过来的扑克牌数组,调用cardsSort,drawothers,drawuser,placeCards,initPlay</span></div><div class="line">        startGame:<span class="function"><span class="keyword">function</span> (<span class="params">seats,turn</span>) </span>&#123;&#125;,</div><div class="line">        <span class="comment">//出牌前的逻辑判断,判断牌是否能压过上家或者是否符合逻辑</span></div><div class="line">        preSend:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;,</div><div class="line">        <span class="comment">//在status为WATING时点击出牌调用的函数</span></div><div class="line">        notYourTurn:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;,</div><div class="line">        <span class="comment">//压牌逻辑的实现,temp存储着牌型,牌的值和牌的数量</span></div><div class="line">        compWhichLarger:<span class="function"><span class="keyword">function</span> (<span class="params">temp</span>) </span>&#123;&#125;,</div><div class="line">        <span class="comment">//绑定座位点击坐下事件</span></div><div class="line">        init:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;,</div><div class="line">        <span class="comment">//游戏结束正常调用end函数,isWin为true则该玩家胜利</span></div><div class="line">        end:<span class="function"><span class="keyword">function</span> (<span class="params">isWin</span>) </span>&#123;&#125;,</div><div class="line">        <span class="comment">//重开一局,array为来自服务器的扑克牌数组,turn为先出牌的人</span></div><div class="line">        reStart:<span class="function"><span class="keyword">function</span> (<span class="params">array,turn</span>) </span>&#123;&#125;,</div><div class="line">        <span class="comment">//切换准备按钮的状态,准备-&gt;取消,取消-&gt;准备</span></div><div class="line">        readyGame:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;,</div><div class="line">        <span class="comment">//游戏结束</span></div><div class="line">        gameover:<span class="function"><span class="keyword">function</span> (<span class="params">isWin</span>) </span>&#123;&#125;,</div><div class="line">        <span class="comment">//放弃出牌</span></div><div class="line">        giveUp:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;,</div><div class="line">        <span class="comment">//放弃出牌得到服务器回应</span></div><div class="line">        giveUpReply:<span class="function"><span class="keyword">function</span> (<span class="params">giupCount</span>) </span>&#123;&#125;,</div><div class="line">        <span class="comment">//绑定一系列点击事件</span></div><div class="line">        initPlay:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</div><div class="line">    &#125;</div><div class="line">    MODAL = modalBox;</div><div class="line">    <span class="keyword">return</span> modalBox.init();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="5-2-出牌流程"><a href="#5-2-出牌流程" class="headerlink" title="5.2 出牌流程"></a>5.2 出牌流程</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//出牌按钮绑定状态机,根据当前状态运行对应的函数,只有在处于DISCARD状态才能正常发牌</span></div><div class="line">$(<span class="string">"body"</span>).on(<span class="string">"click"</span>,<span class="string">"#sendCards"</span>,statusMachine);</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">statusMachine</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">switch</span>(MODAL.default.status)&#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">"DISCARD"</span>:</div><div class="line">            <span class="comment">//运行至preSend函数</span></div><div class="line">            MODAL.preSend();</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="string">"WAITNG"</span>:</div><div class="line">            MODAL.notYourTurn();</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="string">"GAMEOVER"</span>:</div><div class="line">            MODAL.readyGame();</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> modalBox = &#123;</div><div class="line">        <span class="attr">preSend</span>:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> array  = <span class="keyword">new</span> <span class="built_in">Array</span>();</div><div class="line">            <span class="comment">//将被选择(用select来标识)的扑克牌的下标取出,插入数组array中</span></div><div class="line">            $(<span class="string">".cardsLine .card"</span>).each(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">                <span class="keyword">if</span>($(<span class="keyword">this</span>).hasClass(<span class="string">"select"</span>))&#123;</div><div class="line">                    array.push($(<span class="keyword">this</span>).attr(<span class="string">"index"</span>));</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">            <span class="comment">//compCards函数参数为排过序的array,因为用户手牌已经按照一定顺序排过序,所以按照一个方向取出来的牌也是具有一定是有序列的</span></div><div class="line">            <span class="keyword">var</span> temp = compCards(array);</div><div class="line">            <span class="comment">//console.log(compCards(array));</span></div><div class="line">            <span class="comment">//console.log(temp);</span></div><div class="line">            <span class="comment">//disCardTrue为true标识之前已经有两个人放弃出牌,所以不需要考虑压牌,只需要牌型符合一定规则即可出牌</span></div><div class="line">            <span class="keyword">if</span>(MODAL.default.disCardTrue)&#123;</div><div class="line">                <span class="keyword">if</span>(temp.type!=<span class="string">"ERR"</span>)&#123;</div><div class="line">                    socketFun.sendCards(array);</div><div class="line">                &#125;<span class="keyword">else</span>&#123;</div><div class="line">                    alert(<span class="string">"无法出牌"</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                <span class="comment">//temp为储存array牌型以及大小等数据的对象,compWhichLarger函数则是将temp与上一位玩家发的牌进行比较,如果大于则flag为true</span></div><div class="line">                <span class="keyword">var</span> flag = ptrThis.compWhichLarger(temp);</div><div class="line">                <span class="keyword">if</span>(flag)&#123;</div><div class="line">                    <span class="comment">//将array发送至服务器,如果服务器将接受成功的消息发回,则调用 justifyWhich函数</span></div><div class="line">                    socketFun.sendCards(array);</div><div class="line">                &#125;<span class="keyword">else</span>&#123;</div><div class="line">                    alert(<span class="string">"无法出牌"</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//ptrThis.sendCards();</span></div><div class="line">        &#125;,</div><div class="line"></div><div class="line"></div><div class="line">        <span class="attr">justifyWhich</span>:<span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;<span class="comment">//ojb为服务器发送的消息,包含发牌人,发的牌的信息</span></div><div class="line">            <span class="keyword">if</span>(obj.posterIndex!=MODAL.default.myIndex)&#123;</div><div class="line">                 <span class="comment">//如果是别人出的牌,则储存该牌型</span></div><div class="line">                MODAL.default.formercardsType=compCards(obj.array);</div><div class="line">            &#125;</div><div class="line">            MODAL.default.disCardTrue = <span class="literal">false</span>;</div><div class="line">            <span class="keyword">var</span> $goal;<span class="comment">//$goal为待渲染的部位</span></div><div class="line"></div><div class="line"></div><div class="line">            <span class="keyword">switch</span>(obj.posterIndex)&#123;</div><div class="line">                <span class="keyword">case</span> MODAL.default.myIndex:</div><div class="line">                    ptrThis.removeCards();</div><div class="line">                    $goal = $(<span class="string">".showCardLine"</span>);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> MODAL.default.leftIndex:</div><div class="line">                    $goal = $(<span class="string">".leftPlayer"</span>).children(<span class="string">".otherCards"</span>);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> MODAL.default.rightIndex:</div><div class="line">                    $goal = $(<span class="string">".rightPlayer"</span>).children(<span class="string">".otherCards"</span>);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            ptrThis.placeCards($goal,obj.array,<span class="literal">false</span>);</div><div class="line">            <span class="comment">//进入下一回合,轮次加一</span></div><div class="line">            MODAL.default.turn = (MODAL.default.turn+<span class="number">1</span>)%<span class="number">3</span>;</div><div class="line">            <span class="built_in">console</span>.log(<span class="string">"Now turn is"</span>+MODAL.default.turn);</div><div class="line">            <span class="comment">//设置下一回合该玩家是出牌还是等待</span></div><div class="line">            <span class="keyword">if</span>(MODAL.default.turn==MODAL.default.myIndex)&#123;</div><div class="line">                MODAL.default.status = <span class="string">"DISCARD"</span>;</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                MODAL.default.status = <span class="string">"WAITNG"</span></div><div class="line">            &#125;</div><div class="line">            <span class="comment">//如果某一位玩家出完牌,则游戏结束</span></div><div class="line">            <span class="keyword">if</span>(obj.sendOut)&#123;</div><div class="line">                <span class="keyword">if</span>(obj.posterIndex==MODAL.default.myIndex)&#123;</div><div class="line">                    ptrThis.end(<span class="literal">true</span>);</div><div class="line">                &#125;<span class="keyword">else</span>&#123;</div><div class="line">                    ptrThis.end(<span class="literal">false</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="5-3-客户端SocketIO消息模型"><a href="#5-3-客户端SocketIO消息模型" class="headerlink" title="5.3 客户端SocketIO消息模型"></a>5.3 客户端SocketIO消息模型</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> socket = io.connect(<span class="string">'http://localhost:3000'</span>);</div><div class="line"><span class="keyword">var</span> X = <span class="built_in">window</span>.scriptData;                          <span class="comment">//截取服务器发送过来的数据</span></div><div class="line">    <span class="comment">//收到服务器发送的不同的消息类型,调用对应的出牌模型中的函数</span></div><div class="line">    socket.on(<span class="string">"connect"</span>,<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        socket.emit(<span class="string">"addUser"</span>,X._id);                   <span class="comment">//添加用户</span></div><div class="line">    &#125;)</div><div class="line">    socket.on(<span class="string">"playerSit"</span>,<span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</div><div class="line">        MODAL.insertImg($(<span class="string">".seat"</span>).eq(obj.index).children(),obj);</div><div class="line">    &#125;)</div><div class="line">    socket.on(<span class="string">"leave"</span>,<span class="function"><span class="keyword">function</span> (<span class="params">index</span>) </span>&#123;</div><div class="line">        MODAL.removeImg($(<span class="string">".seat"</span>).eq(index).children());</div><div class="line">    &#125;)</div><div class="line">    socket.on(<span class="string">"seatsInfo"</span>,<span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">"seatsInfo"</span>+obj);</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> key <span class="keyword">in</span> obj)&#123;</div><div class="line">            <span class="built_in">console</span>.log(key);</div><div class="line">            MODAL.insertImg($(<span class="string">".seat"</span>).eq(obj[key].index).children(),obj[key]);</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">    socket.on(<span class="string">"gameStart"</span>,<span class="function"><span class="keyword">function</span> (<span class="params">obj,turn</span>) </span>&#123;<span class="comment">//服务器通知玩家游戏开始</span></div><div class="line">        MODAL.startGame(obj,turn);</div><div class="line">    &#125;)</div><div class="line">    socket.on(<span class="string">"postCards"</span>,<span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;<span class="comment">//服务器返回出牌人以及出牌信息</span></div><div class="line">        MODAL.justifyWhich(obj);</div><div class="line">    &#125;)</div><div class="line">    socket.on(<span class="string">"reStart"</span>,<span class="function"><span class="keyword">function</span> (<span class="params">array,turn</span>) </span>&#123;<span class="comment">//服务器返回重新开始游戏的信息</span></div><div class="line">        MODAL.reStart(array,turn);</div><div class="line">    &#125;)</div><div class="line">    socket.on(<span class="string">"giveup"</span>,<span class="function"><span class="keyword">function</span> (<span class="params">giupCount</span>) </span>&#123;<span class="comment">//服务器返回放弃信息</span></div><div class="line">        MODAL.giveUpReply(giupCount);</div><div class="line">    &#125;)</div><div class="line">    socket.on(<span class="string">"renshu"</span>,<span class="function"><span class="keyword">function</span> (<span class="params">seats</span>) </span>&#123;</div><div class="line">        MODAL.someOneTouXiang(seats);</div><div class="line">    &#125;)</div><div class="line"><span class="keyword">var</span> socketFun = &#123;</div><div class="line">    <span class="comment">//出牌对象通过socketFun调用相关函数与服务器通信</span></div><div class="line">    sit:<span class="function"><span class="keyword">function</span> (<span class="params">$this</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> obj = &#123;</div><div class="line">            <span class="attr">id</span>:X._id,</div><div class="line">            <span class="attr">index</span>:$<span class="keyword">this</span>.parent().index()</div><div class="line">        &#125;</div><div class="line">        socket.emit(<span class="string">"sitSeat"</span>,obj);</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">sendCards</span>:<span class="function"><span class="keyword">function</span> (<span class="params">array</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> sendOut;</div><div class="line">        <span class="keyword">if</span>(($(<span class="string">".cardsLine .cards"</span>).children().length-array.length)==<span class="number">0</span>)&#123;</div><div class="line">            sendOut = <span class="literal">true</span>;</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            sendOut = <span class="literal">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">var</span> obj = &#123;</div><div class="line">            <span class="attr">array</span>:array,</div><div class="line">            <span class="attr">posterIndex</span>:MODAL.default.myIndex,</div><div class="line">            <span class="attr">sendOut</span>:sendOut</div><div class="line">        &#125;</div><div class="line">        socket.emit(<span class="string">"postCards"</span>,obj);</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">readyMsg</span>:<span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;<span class="comment">//告知服务器该玩家准备</span></div><div class="line">        socket.emit(<span class="string">"readyMsg"</span>,obj);</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">giveUp</span>:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;<span class="comment">//告知服务器放弃出牌</span></div><div class="line">        socket.emit(<span class="string">"giveup"</span>);</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">touxiang</span>:<span class="function"><span class="keyword">function</span> (<span class="params">index</span>) </span>&#123;<span class="comment">//告知服务器该玩家投降</span></div><div class="line">        socket.emit(<span class="string">"touxiang"</span>,index)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="5-4-压牌逻辑"><a href="#5-4-压牌逻辑" class="headerlink" title="5.4 压牌逻辑"></a>5.4 压牌逻辑</h5><h6 id="根据牌型数组判断牌型的逻辑使用状态机实现，其状态迁移图如下："><a href="#根据牌型数组判断牌型的逻辑使用状态机实现，其状态迁移图如下：" class="headerlink" title="根据牌型数组判断牌型的逻辑使用状态机实现，其状态迁移图如下："></a>根据牌型数组判断牌型的逻辑使用状态机实现，其状态迁移图如下：</h6><p><img src="/2017/05/01/nodejs2/8.png" alt="Alert~"><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">compCards</span>(<span class="params">array</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span>(array.length==<span class="number">2</span>&amp;&amp;data[array[<span class="number">0</span>]].value==<span class="number">16</span>&amp;&amp;data[array[<span class="number">1</span>]].value==<span class="number">15</span>)&#123;<span class="comment">//天王炸</span></div><div class="line">          <span class="keyword">var</span>         cardsType=&#123;</div><div class="line">                            <span class="attr">count</span>:array.length,</div><div class="line">                            <span class="attr">type</span>:<span class="string">"KINGBOMB"</span>,</div><div class="line">                            <span class="attr">value</span>:data[array[<span class="number">0</span>]].value</div><div class="line">                        &#125;;</div><div class="line">           <span class="keyword">return</span> cardsType;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//ptr指向array的下标</span></div><div class="line">    <span class="keyword">var</span> ptr;</div><div class="line">    <span class="comment">//end标志状态机是否结束</span></div><div class="line">    <span class="keyword">var</span> end = <span class="literal">false</span>;</div><div class="line">    <span class="comment">//data存储着每一张扑克的value,避免多次运算value</span></div><div class="line">    <span class="keyword">var</span> box = &#123;</div><div class="line">        <span class="attr">cardsType</span>:&#123;</div><div class="line">            <span class="attr">count</span>:array.length,</div><div class="line">            <span class="attr">type</span>:<span class="string">"ONE"</span>,</div><div class="line">            <span class="attr">value</span>:data[array[<span class="number">0</span>]].value</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">setType</span>:<span class="function"><span class="keyword">function</span> (<span class="params">type</span>) </span>&#123;</div><div class="line">            <span class="keyword">this</span>.cardsType.type = type;</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">statusOne</span>:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.cardsType.count==<span class="number">1</span>)&#123;</div><div class="line">                end = <span class="literal">true</span>;</div><div class="line">                <span class="keyword">return</span> ;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span>(data[array[<span class="number">0</span>]].value==data[array[<span class="number">1</span>]].value)&#123;          <span class="comment">//如果第一个和第二个数字相同</span></div><div class="line">                <span class="keyword">this</span>.setType(<span class="string">"TWO"</span>);</div><div class="line">                <span class="keyword">return</span> ;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span>(data[array[<span class="number">0</span>]].value==data[array[<span class="number">1</span>]].value+<span class="number">1</span>)&#123;</div><div class="line">                <span class="keyword">this</span>.setType(<span class="string">"STRAIGHT"</span>);</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                <span class="keyword">this</span>.setType(<span class="string">"ERR"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> ;</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">statusTwo</span>:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.cardsType.count==<span class="number">2</span>)&#123;</div><div class="line">                end = <span class="literal">true</span>;</div><div class="line">                <span class="keyword">return</span> ;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span>(data[array[<span class="number">1</span>]].value==data[array[<span class="number">2</span>]].value)&#123;</div><div class="line">                <span class="keyword">this</span>.setType(<span class="string">"THREE"</span>);</div><div class="line">                <span class="keyword">return</span> ;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span>(data[array[<span class="number">1</span>]].value==data[array[<span class="number">2</span>]].value+<span class="number">1</span>)&#123;</div><div class="line">                <span class="keyword">this</span>.setType(<span class="string">"TWO-ONE"</span>);</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                <span class="keyword">this</span>.setType(<span class="string">"ERR"</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">statusThree</span>:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.cardsType.count==<span class="number">3</span>)&#123;</div><div class="line">                end = <span class="literal">true</span>;</div><div class="line">                <span class="keyword">return</span> ;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span>(data[array[<span class="number">2</span>]].value==data[array[<span class="number">3</span>]].value)&#123;</div><div class="line">                <span class="keyword">this</span>.setType(<span class="string">"BOMB"</span>);</div><div class="line">                <span class="keyword">return</span> ;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span>(data[array[<span class="number">2</span>]].value==data[array[<span class="number">3</span>]].value+<span class="number">1</span>)&#123;</div><div class="line">                <span class="keyword">this</span>.setType(<span class="string">"THREE-ONE"</span>);</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                <span class="keyword">this</span>.setType(<span class="string">"ERR"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> ;</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">statusStraight</span>:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.cardsType.count&lt; <span class="number">5</span>)&#123;</div><div class="line">                <span class="keyword">this</span>.setType(<span class="string">"ERR"</span>);</div><div class="line">                end = <span class="literal">true</span>;</div><div class="line">                <span class="keyword">return</span> ;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span>(ptr&lt; <span class="keyword">this</span>.cardsType.count<span class="number">-1</span>)&#123;</div><div class="line">                <span class="keyword">if</span>(data[array[ptr]].value!=data[array[ptr+<span class="number">1</span>]].value+<span class="number">1</span>)&#123;</div><div class="line">                    <span class="keyword">this</span>.setType(<span class="string">"ERR"</span>);</div><div class="line">                    end = <span class="literal">true</span>;</div><div class="line">                    <span class="keyword">return</span> ;</div><div class="line">                &#125;</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                end = <span class="literal">true</span>;</div><div class="line">                <span class="keyword">return</span> ;</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">statusTwoOne</span>:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span>(ptr==<span class="keyword">this</span>.cardsType.count<span class="number">-1</span>)&#123;                <span class="comment">//TwoOne处于中间状态,结束则出错</span></div><div class="line">                <span class="keyword">this</span>.setType(<span class="string">"ERR"</span>);</div><div class="line">                <span class="keyword">return</span> ;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span>(data[array[ptr]].value==data[array[ptr+<span class="number">1</span>]].value)&#123;</div><div class="line">                <span class="keyword">this</span>.setType(<span class="string">"TWO-TWO"</span>);</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                <span class="keyword">this</span>.setType(<span class="string">"ERR"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> ;</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">statusTwoTwo</span>:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span>(ptr==<span class="keyword">this</span>.cardsType.count<span class="number">-1</span>)&#123;</div><div class="line">                end = <span class="literal">true</span>;</div><div class="line">                <span class="keyword">return</span> ;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span>(data[array[ptr]].value==data[array[ptr]].value+<span class="number">1</span>)&#123;</div><div class="line">                <span class="keyword">this</span>.setType(<span class="string">"TWO-ONE"</span>);</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                <span class="keyword">this</span>.setType(<span class="string">"ERR"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> ;</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">statusThreeOne</span>:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span>(ptr==<span class="keyword">this</span>.cardsType.count<span class="number">-1</span>)&#123;</div><div class="line">                <span class="keyword">this</span>.setType(<span class="string">"ERR"</span>);</div><div class="line">                <span class="keyword">return</span> ;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span>(data[array[ptr]].value==data[array[ptr+<span class="number">1</span>]].value)&#123;</div><div class="line">                <span class="keyword">this</span>.setType(<span class="string">"THREE-TWO"</span>);</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                <span class="keyword">this</span>.setType(<span class="string">"ERR"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> ;</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">statusThreeTwo</span>:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span>(ptr==<span class="keyword">this</span>.cardsType.count<span class="number">-1</span>)&#123;</div><div class="line">                <span class="keyword">this</span>.setType(<span class="string">"ERR"</span>);</div><div class="line">                <span class="keyword">return</span> ;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span>(data[array[ptr]].value==data[array[ptr+<span class="number">1</span>]].value)&#123;</div><div class="line">                <span class="keyword">this</span>.setType(<span class="string">"THREE-THREE"</span>);</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                <span class="keyword">this</span>.setType(<span class="string">"ERR"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> ;</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">statusThreeThree</span>:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span>(ptr==<span class="keyword">this</span>.cardsType.count<span class="number">-1</span>)&#123;</div><div class="line">                end = <span class="literal">true</span>;</div><div class="line">                <span class="keyword">return</span> ;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span>(data[array[ptr]].value==data[array[ptr+<span class="number">1</span>]].value+<span class="number">1</span>)&#123;</div><div class="line">                <span class="keyword">this</span>.setType(<span class="string">"THREE-ONE"</span>);</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                <span class="keyword">this</span>.setType(<span class="string">"ERR"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> ;</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">statusBomb</span>:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span>(ptr==<span class="keyword">this</span>.cardsType.count<span class="number">-1</span>)&#123;</div><div class="line">                end = <span class="literal">true</span>;</div><div class="line">                <span class="keyword">return</span> ;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span>(data[array[ptr]].value!=data[array[ptr+<span class="number">1</span>]].value)&#123;</div><div class="line">                <span class="keyword">this</span>.setType(<span class="string">"ERR"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">ERR</span>:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            end = <span class="literal">true</span>;</div><div class="line">            <span class="keyword">return</span> ;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">for</span>(ptr = <span class="number">0</span>;ptr&lt; box.cardsType.count;++ptr)&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">"END:"</span>+end);</div><div class="line">        <span class="built_in">console</span>.log(box.cardsType);</div><div class="line">        <span class="keyword">if</span>(end)&#123;</div><div class="line"></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">switch</span>(box.cardsType.type)&#123;</div><div class="line">            <span class="comment">//ONE表示单张牌,这个ONE状态结束有效</span></div><div class="line">            <span class="keyword">case</span> <span class="string">"ONE"</span>:</div><div class="line">                box.statusOne();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="comment">//TWO表示一对,结束有效</span></div><div class="line">            <span class="keyword">case</span> <span class="string">"TWO"</span>:</div><div class="line">                box.statusTwo();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="comment">//THREE表示三张一样的牌,结束有效</span></div><div class="line">            <span class="keyword">case</span> <span class="string">"THREE"</span>:</div><div class="line">                box.statusThree();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="comment">//STRAIGHT表示顺子,根据array长度判断是否有效</span></div><div class="line">            <span class="keyword">case</span> <span class="string">"STRAIGHT"</span>:</div><div class="line">                box.statusStraight();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="comment">//TWO-ONE表示形如xx(x+1)(x+1)(x+2)的牌型,结束无效,返回类型ERR</span></div><div class="line">            <span class="keyword">case</span> <span class="string">"TWO-ONE"</span>:</div><div class="line">                box.statusTwoOne();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="string">"TWO-TWO"</span>:</div><div class="line">            <span class="comment">//TWO-TWO表示形如xx(x+1)(x+1)(x+2)(x+2)的牌型,结束有效</span></div><div class="line">                box.statusTwoTwo();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="comment">//THREE-ONE表示形如xxx(x+1)(x+1)(x+1)(x+2)的牌型,结束无效,返回类型ERR</span></div><div class="line">            <span class="keyword">case</span> <span class="string">"THREE-ONE"</span>:</div><div class="line">                box.statusThreeOne();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="comment">//THREE-TWO表示形如xxx(x+1)(x+1)(x+1)(x+2)(x+2)的牌型,结束无效,返回类型ERR</span></div><div class="line">            <span class="keyword">case</span> <span class="string">"THREE-TWO"</span>:</div><div class="line">                box.statusThreeTwo();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="comment">//THREE-THREE表示形如xxx(x+1)(x+1)(x+1)(x+2)(x+2)(x+2)的牌型,结束有效</span></div><div class="line">            <span class="keyword">case</span> <span class="string">"THREE-THREE"</span>:</div><div class="line">                box.statusThreeThree();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="comment">//BOMB表示炸弹,返回有效</span></div><div class="line">            <span class="keyword">case</span> <span class="string">"BOMB"</span>:</div><div class="line">                box.statusBomb();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="comment">//ERR表示牌型不合逻辑,无效</span></div><div class="line">            <span class="keyword">case</span> <span class="string">"ERR"</span>:</div><div class="line">                box.ERR();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> box.cardsType;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

  </section>

  
  
</article>


            <footer class="footer">

    <span class="footer__copyright">&copy; 2014-2015. | 由<a href="https://hexo.io/">Hexo</a>强力驱动 | 主题<a href="https://github.com/someus/huno">Huno</a></span>
    
</footer>
        </div>
    </div>

    <!-- js files -->
    <script src="/js/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/scale.fix.js"></script>
    

    

    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript"> 
        $(document).ready(function(){
            MathJax.Hub.Config({ 
                tex2jax: {inlineMath: [['[latex]','[/latex]'], ['\\(','\\)']]} 
            });
        });
    </script>


    

    <script src="/js/awesome-toc.min.js"></script>
    <script>
        $(document).ready(function(){
            $.awesome_toc({
                overlay: true,
                contentId: "post-content",
            });
        });
    </script>


    
    
    <!--kill ie6 -->
<!--[if IE 6]>
  <script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script>
<![endif]-->

</body>
</html>
